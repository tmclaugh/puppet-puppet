# $Id$
#
# ref: https://ccp.cloudera.com/display/CDHDOC/HBase+Installation
#

class hbase::master {
  require hbase::common
  package { "hadoop-hbase-master":
    ensure  => "latest",
  }

  service { "hadoop-hbase-master-svc" :
    name => "hadoop-hbase-master",
    ensure => true,
    enable => true,
    hasstatus => true
  }
}

class hbase::regionserver {
  require hbase::common
  package { "hadoop-hbase-regionserver":
    ensure  => "latest",
  }
  service { "hadoop-hbase-regionserver-svc" :
    name => "hadoop-hbase-regionserver",
    ensure => true,
    enable => true,
    hasstatus => true
  }
}

class hbase::common {
  require hadoop::base
  Package["hadoop-hbase"] -> File["/etc/hbase/conf"] -> File["/etc/hbase/conf/hbase-site.xml"]
  
  File { 
    owner => "root", 
    group => "root",
    mode => 0644,
  }
  
  file { "/etc/security/limits.d/hbase.conf":
    content => "
hdfs - nofile  65536
hbase - nofile  65536
  "
  }
  file { "/etc/hbase/conf":
    ensure => directory,
    source => 'puppet:///modules/hbase/etc/hbase/conf',
    recurse => true,
    # XXX: We still get .svn but at least we don't get the contents.
    recurselimit => 1,
  }

  file { "/etc/hbase/conf/hbase-site.xml" :
    ensure => present,
    content => template("hbase/hbase-site.xml.erb")
  }
  package { "hadoop-hbase":
    ensure => 'latest',
  }
}
